<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IdaAuthenticatorImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">mosip-identity-plugin</a> &gt; <a href="index.source.html" class="el_package">io.mosip.esignet.plugin.ida.service</a> &gt; <span class="el_source">IdaAuthenticatorImpl.java</span></div><h1>IdaAuthenticatorImpl.java</h1><pre class="source lang-java linenums">/*
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
package io.mosip.esignet.plugin.ida.service;

import java.util.Arrays;
import java.util.List;

import io.mosip.esignet.api.dto.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.RequestEntity;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Component;
import org.springframework.util.CollectionUtils;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;

import com.fasterxml.jackson.databind.ObjectMapper;

import io.mosip.esignet.plugin.ida.dto.GetAllCertificatesResponse;
import io.mosip.esignet.plugin.ida.dto.IdaKycAuthRequest;
import io.mosip.esignet.plugin.ida.dto.IdaKycAuthResponse;
import io.mosip.esignet.plugin.ida.dto.IdaKycExchangeRequest;
import io.mosip.esignet.plugin.ida.dto.IdaKycExchangeResponse;
import io.mosip.esignet.plugin.ida.dto.IdaResponseWrapper;
import io.mosip.esignet.plugin.ida.dto.IdaSendOtpRequest;
import io.mosip.esignet.plugin.ida.helper.AuthTransactionHelper;
import io.mosip.esignet.api.exception.KycAuthException;
import io.mosip.esignet.api.exception.KycExchangeException;
import io.mosip.esignet.api.exception.KycSigningCertificateException;
import io.mosip.esignet.api.exception.SendOtpException;
import io.mosip.esignet.api.spi.Authenticator;
import io.mosip.esignet.api.util.ErrorConstants;
import io.mosip.kernel.core.http.ResponseWrapper;
import lombok.extern.slf4j.Slf4j;


@ConditionalOnProperty(value = &quot;mosip.esignet.integration.authenticator&quot;, havingValue = &quot;IdaAuthenticatorImpl&quot;)
@Component
<span class="fc" id="L47">@Slf4j</span>
<span class="fc" id="L48">public class IdaAuthenticatorImpl implements Authenticator {</span>

    public static final String SIGNATURE_HEADER_NAME = &quot;signature&quot;;
    public static final String AUTHORIZATION_HEADER_NAME = &quot;Authorization&quot;;
    public static final String KYC_EXCHANGE_TYPE = &quot;oidc&quot;;

    @Value(&quot;${mosip.esignet.authenticator.ida-auth-id:mosip.identity.kycauth}&quot;)
    private String kycAuthId;

    @Value(&quot;${mosip.esignet.authenticator.ida-exchange-id:mosip.identity.kycexchange}&quot;)
    private String kycExchangeId;

    @Value(&quot;${mosip.esignet.authenticator.ida-version:1.0}&quot;)
    private String idaVersion;

    @Value(&quot;${mosip.esignet.authenticator.ida-domainUri}&quot;)
    private String idaDomainUri;

    @Value(&quot;${mosip.esignet.authenticator.ida-env:Staging}&quot;)
    private String idaEnv;

    @Value(&quot;${mosip.esignet.authenticator.ida.kyc-auth-url}&quot;)
    private String kycAuthUrl;
    
    @Value(&quot;${mosip.esignet.authenticator.ida.kyc-exchange-url}&quot;)
    private String kycExchangeUrl;

    @Value(&quot;${mosip.esignet.authenticator.ida.otp-channels}&quot;)
    private List&lt;String&gt; otpChannels;

    @Value(&quot;${mosip.esignet.authenticator.ida.get-certificates-url}&quot;)
    private String getCertsUrl;
    
    @Value(&quot;${mosip.esignet.authenticator.ida.application-id:IDA}&quot;)
    private String applicationId;
    
    @Value(&quot;${mosip.esignet.authenticator.ida.reference-id:SIGN}&quot;)
    private String referenceId;
    
    @Value(&quot;${mosip.esignet.authenticator.ida.client-id}&quot;)
    private String clientId;

    @Autowired
    private ObjectMapper objectMapper;

    @Autowired
    private RestTemplate restTemplate;

    @Autowired
    HelperService helperService;
    
    @Autowired
    private AuthTransactionHelper authTransactionHelper;

    @Override
    public KycAuthResult doKycAuth(String relyingPartyId, String clientId, KycAuthDto kycAuthDto)
            throws KycAuthException {
<span class="fc" id="L105">        log.info(&quot;Started to build kyc-auth request with transactionId : {} &amp;&amp; clientId : {}&quot;,</span>
<span class="fc" id="L106">                kycAuthDto.getTransactionId(), clientId);</span>
        try {
<span class="fc" id="L108">            IdaKycAuthRequest idaKycAuthRequest = new IdaKycAuthRequest();</span>
<span class="fc" id="L109">            idaKycAuthRequest.setId(kycAuthId);</span>
<span class="fc" id="L110">            idaKycAuthRequest.setVersion(idaVersion);</span>
<span class="fc" id="L111">            idaKycAuthRequest.setRequestTime(HelperService.getUTCDateTime());</span>
<span class="fc" id="L112">            idaKycAuthRequest.setDomainUri(idaDomainUri);</span>
<span class="fc" id="L113">            idaKycAuthRequest.setEnv(idaEnv);</span>
<span class="fc" id="L114">            idaKycAuthRequest.setConsentObtained(true);</span>
<span class="fc" id="L115">            idaKycAuthRequest.setIndividualId(kycAuthDto.getIndividualId());</span>
<span class="fc" id="L116">            idaKycAuthRequest.setTransactionID(kycAuthDto.getTransactionId());</span>
<span class="fc" id="L117">            helperService.setAuthRequest(kycAuthDto.getChallengeList(), idaKycAuthRequest);</span>

            //set signature header, body and invoke kyc auth endpoint
<span class="fc" id="L120">            String requestBody = objectMapper.writeValueAsString(idaKycAuthRequest);</span>
<span class="fc" id="L121">            RequestEntity requestEntity = RequestEntity</span>
<span class="fc" id="L122">                    .post(UriComponentsBuilder.fromUriString(kycAuthUrl).pathSegment(relyingPartyId, clientId).build().toUri())</span>
<span class="fc" id="L123">                    .contentType(MediaType.APPLICATION_JSON_UTF8)</span>
<span class="fc" id="L124">                    .header(SIGNATURE_HEADER_NAME, helperService.getRequestSignature(requestBody))</span>
<span class="fc" id="L125">                    .header(AUTHORIZATION_HEADER_NAME, AUTHORIZATION_HEADER_NAME)</span>
<span class="fc" id="L126">                    .body(requestBody);</span>
<span class="fc" id="L127">            ResponseEntity&lt;IdaResponseWrapper&lt;IdaKycAuthResponse&gt;&gt; responseEntity = restTemplate.exchange(requestEntity,</span>
<span class="fc" id="L128">                    new ParameterizedTypeReference&lt;IdaResponseWrapper&lt;IdaKycAuthResponse&gt;&gt;() {});</span>

<span class="pc bpc" id="L130" title="2 of 4 branches missed.">            if(responseEntity.getStatusCode().is2xxSuccessful() &amp;&amp; responseEntity.getBody() != null) {</span>
<span class="fc" id="L131">                IdaResponseWrapper&lt;IdaKycAuthResponse&gt; responseWrapper = responseEntity.getBody();</span>
<span class="pc bpc" id="L132" title="3 of 6 branches missed.">                if(responseWrapper.getResponse() != null &amp;&amp; responseWrapper.getResponse().isKycStatus() &amp;&amp; responseWrapper.getResponse().getKycToken() != null) {</span>
<span class="fc" id="L133">                    return new KycAuthResult(responseEntity.getBody().getResponse().getKycToken(),</span>
<span class="fc" id="L134">                            responseEntity.getBody().getResponse().getAuthToken());</span>
                }
<span class="nc" id="L136">                log.error(&quot;Error response received from IDA KycStatus : {} &amp;&amp; Errors: {}&quot;,</span>
<span class="nc" id="L137">                        responseWrapper.getResponse().isKycStatus(), responseWrapper.getErrors());</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                throw new KycAuthException(CollectionUtils.isEmpty(responseWrapper.getErrors()) ?</span>
<span class="nc" id="L139">                         ErrorConstants.AUTH_FAILED : responseWrapper.getErrors().get(0).getErrorCode());</span>
            }

<span class="nc" id="L142">            log.error(&quot;Error response received from IDA (Kyc-auth) with status : {}&quot;, responseEntity.getStatusCode());</span>
<span class="pc" id="L143">        } catch (KycAuthException e) { throw e; } catch (Exception e) {</span>
<span class="fc" id="L144">            log.error(&quot;KYC-auth failed with transactionId : {} &amp;&amp; clientId : {}&quot;, kycAuthDto.getTransactionId(),</span>
                    clientId, e);
<span class="nc" id="L146">        }</span>
<span class="fc" id="L147">        throw new KycAuthException(ErrorConstants.AUTH_FAILED);</span>
    }

    @Override
    public KycExchangeResult doKycExchange(String relyingPartyId, String clientId, KycExchangeDto kycExchangeDto)
            throws KycExchangeException {
<span class="fc" id="L153">        log.info(&quot;Started to build kyc-exchange request with transactionId : {} &amp;&amp; clientId : {}&quot;,</span>
<span class="fc" id="L154">                kycExchangeDto.getTransactionId(), clientId);</span>
        try {
<span class="fc" id="L156">            IdaKycExchangeRequest idaKycExchangeRequest = new IdaKycExchangeRequest();</span>
<span class="fc" id="L157">            idaKycExchangeRequest.setId(kycExchangeId);</span>
<span class="fc" id="L158">            idaKycExchangeRequest.setVersion(idaVersion);</span>
<span class="fc" id="L159">            idaKycExchangeRequest.setRequestTime(HelperService.getUTCDateTime());</span>
<span class="fc" id="L160">            idaKycExchangeRequest.setTransactionID(kycExchangeDto.getTransactionId());</span>
<span class="fc" id="L161">            idaKycExchangeRequest.setKycToken(kycExchangeDto.getKycToken());</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">	    if (!CollectionUtils.isEmpty(kycExchangeDto.getAcceptedClaims())) {</span>
<span class="fc" id="L163">                idaKycExchangeRequest.setConsentObtained(kycExchangeDto.getAcceptedClaims());</span>
            } else {
<span class="fc" id="L165">                idaKycExchangeRequest.setConsentObtained(List.of(&quot;sub&quot;));</span>
            }
<span class="fc" id="L167">            idaKycExchangeRequest.setLocales(Arrays.asList(kycExchangeDto.getClaimsLocales()));</span>
<span class="fc" id="L168">            idaKycExchangeRequest.setRespType(kycExchangeDto.getUserInfoResponseType()); //may be either JWT or JWE</span>
<span class="fc" id="L169">            idaKycExchangeRequest.setIndividualId(kycExchangeDto.getIndividualId());</span>

            //set signature header, body and invoke kyc exchange endpoint
<span class="fc" id="L172">            String requestBody = objectMapper.writeValueAsString(idaKycExchangeRequest);</span>
<span class="fc" id="L173">            RequestEntity requestEntity = RequestEntity</span>
<span class="fc" id="L174">                    .post(UriComponentsBuilder.fromUriString(kycExchangeUrl).pathSegment(relyingPartyId,</span>
<span class="fc" id="L175">                            clientId).build().toUri())</span>
<span class="fc" id="L176">                    .contentType(MediaType.APPLICATION_JSON_UTF8)</span>
<span class="fc" id="L177">                    .header(SIGNATURE_HEADER_NAME, helperService.getRequestSignature(requestBody))</span>
<span class="fc" id="L178">                    .header(AUTHORIZATION_HEADER_NAME, AUTHORIZATION_HEADER_NAME)</span>
<span class="fc" id="L179">                    .body(requestBody);</span>
<span class="fc" id="L180">            ResponseEntity&lt;IdaResponseWrapper&lt;IdaKycExchangeResponse&gt;&gt; responseEntity = restTemplate.exchange(requestEntity,</span>
<span class="fc" id="L181">                    new ParameterizedTypeReference&lt;IdaResponseWrapper&lt;IdaKycExchangeResponse&gt;&gt;() {});</span>

<span class="pc bpc" id="L183" title="2 of 4 branches missed.">            if(responseEntity.getStatusCode().is2xxSuccessful() &amp;&amp; responseEntity.getBody() != null) {</span>
<span class="fc" id="L184">                IdaResponseWrapper&lt;IdaKycExchangeResponse&gt; responseWrapper = responseEntity.getBody();</span>
<span class="pc bpc" id="L185" title="1 of 4 branches missed.">                if(responseWrapper.getResponse() != null &amp;&amp; responseWrapper.getResponse().getEncryptedKyc() != null) {</span>
<span class="fc" id="L186">                    return new KycExchangeResult(responseWrapper.getResponse().getEncryptedKyc());</span>
                }
<span class="fc" id="L188">                log.error(&quot;Errors in response received from IDA Kyc Exchange: {}&quot;, responseWrapper.getErrors());</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">                throw new KycExchangeException(CollectionUtils.isEmpty(responseWrapper.getErrors()) ?</span>
<span class="pc" id="L190">                		ErrorConstants.DATA_EXCHANGE_FAILED : responseWrapper.getErrors().get(0).getErrorCode());</span>
            }

<span class="nc" id="L193">            log.error(&quot;Error response received from IDA (Kyc-exchange) with status : {}&quot;, responseEntity.getStatusCode());</span>
<span class="fc" id="L194">        } catch (KycExchangeException e) { throw e; } catch (Exception e) {</span>
<span class="fc" id="L195">            log.error(&quot;IDA Kyc-exchange failed with clientId : {}&quot;, clientId, e);</span>
<span class="nc" id="L196">        }</span>
<span class="fc" id="L197">        throw new KycExchangeException();</span>
    }

    @Override
    public SendOtpResult sendOtp(String relyingPartyId, String clientId, SendOtpDto sendOtpDto)  throws SendOtpException {
<span class="fc" id="L202">        log.info(&quot;Started to build send-otp request with transactionId : {} &amp;&amp; clientId : {}&quot;,</span>
<span class="fc" id="L203">                sendOtpDto.getTransactionId(), clientId);</span>
        try {
<span class="fc" id="L205">            IdaSendOtpRequest idaSendOtpRequest = new IdaSendOtpRequest();</span>
<span class="fc" id="L206">            idaSendOtpRequest.setOtpChannel(sendOtpDto.getOtpChannels());</span>
<span class="fc" id="L207">            idaSendOtpRequest.setIndividualId(sendOtpDto.getIndividualId());</span>
<span class="fc" id="L208">            idaSendOtpRequest.setTransactionID(sendOtpDto.getTransactionId());</span>
<span class="fc" id="L209">            return helperService.sendOTP(relyingPartyId, clientId, idaSendOtpRequest);</span>
<span class="fc" id="L210">        } catch (SendOtpException e) {</span>
<span class="fc" id="L211">            throw e;</span>
<span class="nc" id="L212">        } catch (Exception e) {</span>
<span class="nc" id="L213">            log.error(&quot;send-otp failed with clientId : {}&quot;, clientId, e);</span>
        }
<span class="nc" id="L215">        throw new SendOtpException();</span>
    }

    @Override
    public boolean isSupportedOtpChannel(String channel) {
<span class="pc bpc" id="L220" title="1 of 4 branches missed.">        return channel != null &amp;&amp; otpChannels.contains(channel.toLowerCase());</span>
    }

    @Override
    public List&lt;KycSigningCertificateData&gt; getAllKycSigningCertificates() throws KycSigningCertificateException {
    	try {
<span class="fc" id="L226">    		String authToken = authTransactionHelper.getAuthToken();</span>

<span class="fc" id="L228">            RequestEntity requestEntity = RequestEntity</span>
<span class="fc" id="L229">                     .get(UriComponentsBuilder.fromUriString(getCertsUrl).queryParam(&quot;applicationId&quot;, applicationId).queryParam(&quot;referenceId&quot;, referenceId).build().toUri())</span>
<span class="fc" id="L230">                     .header(AUTHORIZATION_HEADER_NAME, AUTHORIZATION_HEADER_NAME)</span>
<span class="fc" id="L231">                     .header(HttpHeaders.COOKIE, &quot;Authorization=&quot; + authToken)</span>
<span class="fc" id="L232">                     .build();</span>
            
<span class="fc" id="L234">            ResponseEntity&lt;ResponseWrapper&lt;GetAllCertificatesResponse&gt;&gt; responseEntity = restTemplate.exchange(requestEntity,</span>
<span class="fc" id="L235">                     new ParameterizedTypeReference&lt;ResponseWrapper&lt;GetAllCertificatesResponse&gt;&gt;() {});</span>
            
<span class="pc bpc" id="L237" title="1 of 4 branches missed.">            if(responseEntity.getStatusCode().is2xxSuccessful() &amp;&amp; responseEntity.getBody() != null) {</span>
<span class="fc" id="L238">            	ResponseWrapper&lt;GetAllCertificatesResponse&gt; responseWrapper = responseEntity.getBody();</span>
<span class="pc bpc" id="L239" title="1 of 4 branches missed.">                if(responseWrapper.getResponse() != null &amp;&amp; responseWrapper.getResponse().getAllCertificates() != null) {</span>
<span class="fc" id="L240">                    return responseWrapper.getResponse().getAllCertificates();</span>
                }
<span class="fc" id="L242">                log.error(&quot;Error response received from getAllSigningCertificates with errors: {}&quot;,</span>
<span class="fc" id="L243">                        responseWrapper.getErrors());</span>
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">                throw new KycSigningCertificateException(CollectionUtils.isEmpty(responseWrapper.getErrors()) ?</span>
<span class="pc" id="L245">                		ErrorConstants.KYC_SIGNING_CERTIFICATE_FAILED : responseWrapper.getErrors().get(0).getErrorCode());</span>
            }
<span class="fc" id="L247">            log.error(&quot;Error response received from getAllSigningCertificates with status : {}&quot;, responseEntity.getStatusCode());</span>
<span class="fc" id="L248">    	} catch (KycSigningCertificateException e) { throw e; } catch (Exception e) {</span>
<span class="fc" id="L249">            log.error(&quot;getAllKycSigningCertificates failed with clientId : {}&quot;, clientId, e);</span>
<span class="fc" id="L250">        }</span>
<span class="fc" id="L251">    	throw new KycSigningCertificateException();</span>
    }

    @Override
    public KycAuthResult doKycAuth(String relyingPartyId, String clientId, boolean claimsMetadataRequired, KycAuthDto kycAuthDto) throws KycAuthException {
<span class="nc" id="L256">        return null;</span>
    }

    @Override
    public KycExchangeResult doVerifiedKycExchange(String relyingPartyId, String clientId, VerifiedKycExchangeDto kycExchangeDto) throws KycExchangeException {
<span class="nc" id="L261">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>